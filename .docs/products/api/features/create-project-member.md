# プロジェクトメンバー追加

既存のプロジェクトに新しいメンバーを追加するためのユースケースです。

## アクター

- プロジェクト管理者（OWNER または ADMIN ロールを持つユーザー）

## 前提条件

- ユーザーがシステムにログインしている
- ユーザーがプロジェクトのOWNERまたはADMINロールを持っている
- 追加対象のユーザーがシステムに登録されている
- 招待されるユーザーがまだプロジェクトのメンバーでないこと

## 成功シナリオ

1. プロジェクト管理者がプロジェクトのメンバー管理ページにアクセスする
2. プロジェクト管理者が「メンバー追加」ボタンをクリックする
3. システムがメンバー追加フォームを表示する
4. プロジェクト管理者が追加するユーザーのメールアドレスを入力する
5. プロジェクト管理者がユーザーに付与するロール（ADMIN、MEMBER、VIEWER）を選択する
6. プロジェクト管理者が「追加」ボタンをクリックする
7. システムが招待者の権限を確認
   If (招待権限がない) Then
     権限エラーを表示して処理を中断
   EndIf
8. システムがメールアドレスの形式を検証する
9. システムがメールアドレスに対応するユーザーを検索する
   If (ユーザーが存在しない) Then
     エラーメッセージを表示して処理を中断
   EndIf
10. システムがユーザーがプロジェクトに既に所属していないことを確認する
   If (すでにメンバーである) Then
     エラーメッセージを表示して処理を中断
   EndIf
11. システムがプロジェクトメンバーエンティティを作成
12. システムがプロジェクトメンバー情報を保存
13. システムが追加されたユーザーに通知を送信する
14. システムがメンバー追加完了の通知を表示する
15. システムがメンバー一覧を更新して表示する

## 代替シナリオ

### メールアドレスに対応するユーザーが存在しない場合

9a. システムがメールアドレスに対応するユーザーが存在しないことを検出する
9b. システムがエラーメッセージを表示する
9c. システムが招待メールを送信するオプションを提案する

### ユーザーが既にプロジェクトメンバーである場合

10a. システムがユーザーが既にプロジェクトメンバーであることを検出する
10b. システムがエラーメッセージを表示する
10c. プロジェクト管理者が別のユーザーを選択するか、既存メンバーのロール変更を行う

## 例外シナリオ

### システムエラーが発生した場合

11a. システムがメンバー追加中にエラーが発生する
11b. システムがエラーメッセージを表示する
11c. システムが管理者にエラーを通知する
11d. プロジェクト管理者が後で再試行するよう促される

## 入力

- プロジェクトID: メンバーを追加するプロジェクトのID
- ユーザーID: 招待するユーザーのID
- ロール: 付与する権限（ADMIN、MEMBER、VIEWER）

## 出力

- 作成されたプロジェクトメンバーエンティティ
- エラー：権限がない場合はPermissionDeniedエラー
- エラー：ユーザーが見つからない場合はNotFoundエラー
- エラー：すでにメンバーの場合はAlreadyExistsエラー
- エラー：内部エラーが発生した場合はInternalエラー

## ビジネスルール

- プロジェクトメンバーの追加はOWNERまたはADMINロールを持つユーザーのみが実行できる
- 同一プロジェクト内で同一ユーザーが複数のメンバーとして登録されることはない
- メンバーのロールは"ADMIN", "MEMBER", "VIEWER"のいずれかでなければならない（OWNERロールは作成時のみ付与される）
- プロジェクトメンバー数はプロジェクトの種類によって制限される（無料プロジェクトは最大10人、有料プロジェクトは最大100人など）

## 関連モデル

- [プロジェクトメンバー](../entities/project-member.md)
- [プロジェクト](../entities/project.md)
- [ユーザー](../entities/user.md)
- [プロジェクト通知](../models/project-notification.md)