# 20.architecture.md

このプロジェクトはモノレポ構成で、レイヤードアーキテクチャとDDD（ドメイン駆動設計）の原則に基づいて設計されています。フロントエンドとバックエンドが明確に分離されており、それぞれが適切なレイヤー構造を持っています。

## バックエンド（api/）

バックエンドはレイヤードアーキテクチャに基づく4つの主要レイヤーで構成されています：

### 1. ドメイン層 (api/domain/)

- システムの中核となるビジネスロジックとルールを含む
- Entityクラス（`*.entity.ts`）：ビジネスエンティティとそのビジネスルールを定義
- 値オブジェクト（`*.value.ts`）：不変のデータ値を表現
- ビジネスルールを検証するためにvalibotを使用

### 2. アプリケーション層 (api/application/)

- ユースケースを実装するクラスを含む
- 各ユースケースクラスはドメイン層のエンティティに対する操作を実行
- 命名パターン：create-*, update-*, delete-* などのアクションを示す
- エラーハンドリングはGraphQLエラークラスを返却

### 3. インフラストラクチャ層 (api/infrastructure/)

- 外部との連携（データベース、APIなど）を担当
- リポジトリ（`*.repository.ts`）：エンティティの永続化を担当
- アダプター（`*.adapter.ts`）：外部サービスとの連携

### 4. インターフェース層 (api/interface/)

- 外部とのやり取りを担当（GraphQL、REST）
- GraphQLのスキーマ定義
- Honoを使用したルーティング
- エラー処理

## フロントエンド（app/）

フロントエンドはReactとTailwindCSSを使用したモダンなアプリケーション構造を持っています：

### 1. インターフェースレイヤー (app/interface/)

- コンポーネント（`components/`）：UIコンポーネント
  - ページコンポーネント（`pages/`）：ページ単位のコンポーネント
  - UIコンポーネント（`ui/`）：shadcn/uiベースのコンポーネント
  - カスタムUIコンポーネント（`ui-custom/`）：カスタマイズしたUIコンポーネント
- ルーティング（`routes/`）：flat-routes構造のルーティング
- フック（`hooks/`）：カスタムReactフック

### 2. ライブラリレイヤー (app/lib/)

- クライアント実装
  - GraphQLクライアント
  - HonoクライアントによるREST API連携
- ユーティリティ関数

## データフロー

1. UIからのユーザーアクション → フロントエンドのカスタムフック
2. GraphQLクライアントを介したAPIリクエスト
3. バックエンドのGraphQLエンドポイント（インターフェース層）
4. アプリケーション層のユースケース実行
5. ドメイン層のエンティティによるビジネスロジック実行
6. インフラストラクチャ層を介したデータ永続化
7. 結果をGraphQLレスポンスとしてフロントエンドに返却
8. フロントエンドでのデータ表示・状態更新

## 認証・認可

- JWTを使用したセッション管理
- Cookie経由での認証情報の保持
- bcrypt-tsによるパスワードハッシュ化

## エラー処理

- バックエンド：GraphQLエラークラスによる統一的なエラーハンドリング
- フロントエンド：toastコンポーネントによるユーザーフレンドリーなエラー表示
